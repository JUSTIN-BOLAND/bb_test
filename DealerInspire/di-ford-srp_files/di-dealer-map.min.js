var DIDealerMap={init:function(options){try{if(typeof google==="undefined"){throw"DIDealerMap: Google maps not found."}}catch(e){console.log(e);return false}var config={mapContainer:"#map",mapSearchContainer:"#dealerSearchContainer",mapDealerListContainer:".dealerResultsList",mapShowListButton:".hideShowZipBox",numClosestResultsToFind:-1,numClosestToShowInList:3,zipCodeFieldSelector:"#zip",zipCodeFormButton:".search",useMetric:false,useGeolocation:true,showCustomerMarker:true,recenterOnCustomerMarker:false,autoClickClosestMarker:true,fillViewport:true,containerHeight:500,pinImage:"/wp-content/themes/DealerInspireDealerTheme/images/map-marker.png",headerOffset:false,mapOptions:{zoom:8,center:{lat:41.7756595,lng:-88.2027888},mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:false,zoomControl:true},dealers:null},_self=this;this.config=$.extend(true,config,options);this.zipCode=this.getURLParameter("zipcode")||null;this.currentMarker=null;this.customerMarker=null;this.showingSearch=true;this.locations=[];this.geolocationData=null;this.calculatedCenter=null;this.mapBounds=new google.maps.LatLngBounds;this.geocoder=new google.maps.Geocoder;this.infoWindow=new google.maps.InfoWindow;this.distanceService=new google.maps.DistanceMatrixService,this.geoPromise=new $.Deferred;$.when(this.getDealerMapLocations()).then(function(locations){_self.locations=locations;_self.initDealerMap()},function(message){console.log(message)});$(document).on("di_geolocation_finished",function(e,loc){if(loc.status==="OK"){_self.geoPromise.resolve(loc.response)}else{_self.geoPromise.reject(loc.status)}})},initDealerMap:function(){var self=this,winHeight=$(window).height(),winWidth=$(window).width(),mapList=$(this.config.mapDealerListContainer),mapContainer=$(this.config.mapContainer);if($(mapList).find("li").length<1){$(mapList).hide()}if(winWidth>767&&this.config.fillViewport===true){winHeight=parseInt(this.config.headerOffset)>0?winHeight-parseInt(this.config.headerOffset):winHeight;$(mapContainer).css("height",winHeight)}else if(winWidth>767&&this.config.fillViewport===false){$(mapContainer).css("height",parseInt(this.config.containerHeight))}if(winWidth<1024&&!this.config.mapOptions.hasOwnProperty("draggable")){this.config.mapOptions.draggable=false}$(window).load(function(){self.setupMap()})},setupMap:function(){var _self=this;window.dealerMap=window.dealerMap||new google.maps.Map(document.querySelector(this.config.mapContainer),this.config.mapOptions);this.addLocationsToMap();if($(this.config.mapContainer).length>0){if(this.config.useGeolocation&&this.geolocationData===null&&!this.zipCode){this.geoPromise.done(function(loc){_self.runGeocode(loc)}).fail(function(message){console.log("DIDealerMap: could not get location")})}else{if(this.isValidPostalCode(this.zipCode)){this.getClosestForZip(this.zipCode)}else{$(".errorMessage").show()}}this.setupEvents()}},runGeocode:function(loc){var latitude=loc.latitude,longitude=loc.longitude,_self=this;$(this.config.mapSearchContainer).find("#dealerSearch").append('<span class="geo-loading"><i class="fa fa-cog fa-spin"></i> getting your location...</span>');if(this.config.mapSearchContainer!==false){_self.geocoder.geocode({location:{lat:latitude,lng:longitude}},function(results,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0;i<results[0].address_components.length;i++){var component=results[0].address_components[i];if(component.types.indexOf("postal_code")>-1){var zip=component.long_name;$(_self.config.zipCodeFieldSelector).val(zip);_self.getClosestForZip(zip)}}}else{console.log("DIDealerMap: "+loc.status)}$(".geo-loading").remove()})}},setupEvents:function(){var _self=this,latLngBoundsChange=null;$(this.config.mapShowListButton).show().on("click",function(e){e.preventDefault();if(!$(this).hasClass("dealer-list-hidden")){$(_self.config.mapSearchContainer).animate({left:"-300px"},400,"swing",function(){});$(this).text("show search").css("background-position","10px 0px").addClass("dealer-list-hidden")}else{$(_self.config.mapSearchContainer).animate({left:"0px"},400,"swing",function(){});$(this).text("hide search").css("background-position","10px -30px").removeClass("dealer-list-hidden")}});$(this.config.zipCodeFieldSelector).keypress(function(e){if(e.which==13){_self.validateZipDoSearch()}});$(this.config.zipCodeFormButton).click(function(e){_self.validateZipDoSearch()});$(this.config.mapDealerListContainer).on("click",".jumpToLoc",function(e){e.preventDefault();var locationIndex=$(this).data("locindex");_self.realignMapToMarker(_self.locations[locationIndex].marker)});latLngBoundsChange=google.maps.event.addListener(window.dealerMap,"bounds_changed",function(event){if(this.getZoom()>_self.config.mapOptions.zoom){this.setZoom(_self.config.mapOptions.zoom)}google.maps.event.removeListener(latLngBoundsChange)});google.maps.event.addDomListener(window,"resize",function(event){_self.fixMapLayout()});google.maps.event.addDomListener(window.dealerMap,"idle",function(){_self.calculatedCenter=window.dealerMap.getCenter()});if(_self.locations.length===1){_self.realignMapToMarker(_self.locations[0].marker)}},fixMapLayout:function(event){var winHeight=$(window).height(),winWidth=$(window).width(),_self=this;if(this.config.headerOffset){winHeight=winHeight-parseInt(this.config.headerOffset)}if(window.requestAnimationFrame){window.requestAnimationFrame(function(){if(_self.config.fillViewport===true){$(_self.config.mapContainer).css("height",winHeight)}if(_self.currentMarker!==null){_self.realignMapToMarker(_self.currentMarker)}else{window.dealerMap.panTo(_self.calculatedCenter)}})}else{setTimeout(function(){if(_self.config.fillViewport===true){$(_self.config.mapContainer).css("height",winHeight)}if(_self.currentMarker!==null){_self.realignMapToMarker(_self.currentMarker)}else{window.dealerMap.panTo(_self.calculatedCenter)}},30)}},validateZipDoSearch:function(){var zip=$(this.config.zipCodeFieldSelector).val(),errorMessage=$(this.config.mapSearchContainer).find(".errorMessage"),_self=this;if(this.isValidPostalCode(zip,"US")){this.zipCode=zip;$(errorMessage).hide();_self.getClosestForZip(this.zipCode)}else{$(errorMessage).show()}},realignMapToMarker:function(marker){this.currentMarker=marker;if(this.config.autoClickClosestMarker===true){new google.maps.event.trigger(marker,"click")}else{window.dealerMap.panTo(marker.getPosition())}},setContentForLocation:function(location){var locationContent='<div class="dealerMapInfo">';locationContent+="<h3>"+location.title+"</h3>";locationContent+='<p class="address">'+location.location.address+"</p>";locationContent+='<p class="phone">'+location.phone_label+' <a href="tel:'+location.dealer_phone+'">'+location.dealer_phone+"</a></p>";locationContent+=' <a class="button primary-button small '+location.dealer_name_slug+'" target="_blank" href="'+location.dealer_website_url+'">'+location.dealer_website_url_button_text+"</a>";locationContent+='<a class="button primary-button small" target="_blank" href="'+location.dealer_directions_url+'">'+location.dealer_directions_url_button_text+"</a>";locationContent+="</div>";return locationContent},addLocationsToMap:function(){var _self=this;for(var i=0,locationsLength=this.locations.length;i<locationsLength;i++){var marker=this.createMapMarker(this.locations[i]);google.maps.event.addListener(marker,"click",function(marker,i){return function(){_self.currentMarker=marker;_self.infoWindow.setContent(_self.locations[i].clickContent);_self.infoWindow.open(window.dealerMap,marker);if(_self.config.fillViewport===true){window.dealerMap.panTo(marker.getPosition())}else{window.dealerMap.setCenter(marker.getPosition())}}}(marker,i));this.locations[i].marker=marker}if(this.locations.length>1){window.dealerMap.fitBounds(this.mapBounds);$(document).trigger("di_dealermap_markers_set")}},createMapMarker:function(location){var marker=new google.maps.Marker({position:{lat:parseFloat(location.location.lat),lng:parseFloat(location.location.lng)},map:window.dealerMap,icon:location.custom_pin_image||this.config.pinImage,zIndex:999+location.pin_z_index||null}),latlng=new google.maps.LatLng(marker.position.lat(),marker.position.lng());this.mapBounds.extend(latlng);return marker},getClosestForZip:function(zip){var numClosestResultsToFind=this.config.numClosestResultsToFind,closest=[],_self=this;try{this.geocoder.geocode({address:zip},function(results,status){if(status==google.maps.GeocoderStatus.OK){var location=results[0].geometry.location;if(numClosestResultsToFind==-1){numClosestResultsToFind=_self.locations.length}closest=_self.findClosestN(location,numClosestResultsToFind);_self.calculateDistances(location,closest);$(_self.config.zipCodeFieldSelector).val(zip);if(_self.config.showCustomerMarker===true){_self.showCustomerLocation(location.lat(),location.lng())}}else{throw"Geocode was not successful for the following reason: "+status}})}catch(e){console.log(e)}},findClosestN:function(pt,numClosestResultsToFind){var closest=[],_self=this;for(var i=0,locationsLength=this.locations.length;i<locationsLength;i++){var location=this.locations[i];location.marker.distance=google.maps.geometry.spherical.computeDistanceBetween(pt,location.marker.getPosition());closest.push(location)}closest=closest.sort(this.sortByDist);return closest.splice(0,numClosestResultsToFind)},sortByDist:function(a,b){return a.marker.distance-b.marker.distance},calculateDistances:function(pt,closest){var request={origins:[pt],destinations:[],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL,avoidHighways:false,avoidTolls:false},_self=this;if(this.config.useMetric===true){request.unitSystem=google.maps.UnitSystem.METRIC}for(var i=0;i<closest.length;i++){request.destinations.push(closest[i].marker.getPosition())}this.distanceService.getDistanceMatrix(request,function(response,status){if(status!=google.maps.DistanceMatrixStatus.OK){console.log("Error was: "+status)}else{var origins=response.originAddresses,destinations=response.destinationAddresses,results=response.rows[0].elements;closest.forEach(function(element,index){element.matrix=results[index]});closest.sort(function(a,b){return a.matrix.distance.value-b.matrix.distance.value});if(_self.config.recenterOnCustomerMarker===false){_self.realignMapToMarker(closest[0].marker)}$(_self.config.mapDealerListContainer).empty();for(var i=0,closestLength=closest.length;i<closestLength;i++){if(i<_self.config.numClosestToShowInList){var newCloseDealerLi="<li class='singleDealerResult'>",directionLink=closest[i].dealer_directions_url;newCloseDealerLi+="<div class='jumpToLoc' data-locindex='"+closest[i].pinId+"'>";newCloseDealerLi+="<h4>";newCloseDealerLi+='<a href="'+closest[i].dealer_website_url+'" target="_blank">';newCloseDealerLi+=closest[i].title;newCloseDealerLi+="</a>";newCloseDealerLi+="</h4>";newCloseDealerLi+='<p class="address">'+closest[i].address+"</p>";newCloseDealerLi+='<p class="phone">Phone: <a href="tel:'+closest[i].dealer_phone+'">'+closest[i].dealer_phone+"</a></p>";newCloseDealerLi+='<p class="distanceAndTime">';newCloseDealerLi+='<span class="distance">'+closest[i].matrix.distance.text+"</span>";newCloseDealerLi+=' appoximately <span class="time">'+closest[i].matrix.duration.text+"</span>";newCloseDealerLi+="</p>";newCloseDealerLi+="</div>";newCloseDealerLi+="<ul class='dealerSearchActionsList'>";newCloseDealerLi+="<li>";newCloseDealerLi+="<div class='getDirections'><a target='_blank' class='directionsLink button primary-button' href='"+directionLink+"'> Get Directions <a/></div>";newCloseDealerLi+="</li>";newCloseDealerLi+="<li>";newCloseDealerLi+="<a target='_blank' class='button primary-button "+closest[i].dealer_name_slug+"' href='"+closest[i].dealer_website_url+"'>Visit Website</a>";newCloseDealerLi+="</li>";newCloseDealerLi+="</ul>";newCloseDealerLi+="</li>";$(_self.config.mapDealerListContainer).show();$(_self.config.mapDealerListContainer).append(newCloseDealerLi)}}$(document).trigger("di_dealermap_closest_found",closest[0])}})},showCustomerLocation:function(latitude,longitude){if(this.customerMarker!==null){this.customerMarker.setMap(null)}this.customerMarker=new google.maps.Marker({map:window.dealerMap,position:{lat:latitude,lng:longitude}});if(this.config.recenterOnCustomerMarker===true){window.dealerMap.panTo(this.customerMarker.getPosition())}}};DIDealerMap.getDealerMapLocations=function(){var _self=this,dfd=jQuery.Deferred(),locations=[],dealers=_self.config.dealers,data={action:"get_dealers"};if(dealers!==null&&dealers.length){var dealerList=dealers.split(",")||[];data.dealer_ids=[];jQuery.each(dealerList,function(index,value){data.dealer_ids.push(parseInt(this))})}if(typeof lo_di_dealer_map!=="undefined"){locations=this.parseDealerMapLocations(lo_di_dealer_map);dfd.resolve(locations)}else{jQuery.ajax({type:"GET",url:"/wp/wp-admin/admin-ajax.php",dataType:"json",data:data,success:function(data){locations=_self.parseDealerMapLocations(data);dfd.resolve(locations)},error:function(xhr,ajaxOptions,thrownError){dfd.reject("DIDealerMap: "+thrownError)}})}return dfd.promise()};DIDealerMap.parseDealerMapLocations=function(data){var locations=[];for(var i=0,dataLength=data.length;i<dataLength;i++){if(data[i].location){data[i].clickContent=this.setContentForLocation(data[i]);data[i].pinId=i;if(data[i].hasOwnProperty("pin_z_index")&&data[i].pin_z_index!==null){data[i].pin_z_index=parseInt(data[i].pin_z_index)}locations.push(data[i])}}return locations};DIDealerMap.getURLParameter=function(name){return decodeURI((RegExp(name+"="+"(.+?)(&|$)").exec(window.location.search)||[,null])[1])};DIDealerMap.isValidPostalCode=function(postalCode,countryCode){switch(countryCode){case"US":postalCodeRegex=/^([0-9]{5})(?:[-\s]*([0-9]{4}))?$/;break;case"CA":postalCodeRegex=/^([A-Z][0-9][A-Z])\s*([0-9][A-Z][0-9])$/;break;default:postalCodeRegex=/^(?:[A-Z0-9]+([- ]?[A-Z0-9]+)*)?$/}return postalCodeRegex.test(postalCode)};