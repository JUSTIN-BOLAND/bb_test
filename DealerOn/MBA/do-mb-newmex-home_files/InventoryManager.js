"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}();dealeron.runtime.define(["system/http","system/logManager","system/linq","system/async","system/text","core/inventory/filters","core/inventory/Vehicle"],function(e,r,n,t,i,a,o){var l=r.getLogger("Inventory Collection Manager"),u=function(){function r(e){_classCallCheck(this,r),e=e||{},this._limitYearsTo=e.limitYearsTo?n.Enumerable.from(e.limitYearsTo).toArray():null,this._limitMakesTo=e.limitMakesTo?n.Enumerable.from(e.limitMakesTo).select(function(e){return e.toLowerCase()}).toArray():null,this._vehiclePromises={}}return _createClass(r,[{key:"_buildInventory",value:function(e){var r=this,t=[];return n.Enumerable.from(e.Makes).where(function(e){return!r._limitMakesTo||r._limitMakesTo.indexOf(e.Name.toLowerCase())!==-1}).forEach(function(e){var i=e.Name,a=n.Enumerable.from(e.Models);a.forEach(function(e){var a=e.Name;n.Enumerable.from(e.Years).where(function(e){return!r._limitYearsTo||r._limitYearsTo.indexOf(e)!==-1}).forEach(function(e){return t.push(new o({Type:"V",Year:e,Make:i,Model:a}))})})}),n.Enumerable.from(t)}},{key:"_buildMakeSpecificInventory",value:function(e){var r=this,t=[],i=e.Name;return n.Enumerable.from(e.Models).forEach(function(e){var a=e.Name,l=n.Enumerable.from(e.Trims);l.forEach(function(e){var l=e.Name,u=e.Bodystyle;n.Enumerable.from(e.Years).where(function(e){return!r._limitYearsTo||r._limitYearsTo.indexOf(e)!==-1}).forEach(function(e){return t.push(new o({Type:"V",Year:e,Make:i,Model:a,Trim:l,Bodystyle:u}))})})}),n.Enumerable.from(t)}},{key:"_fetchRefData",value:function(r){var n=this;return t.await(function(t,i){e.get("/api/virtual/inventory/{make}",{make:(r||"").replace(/\s/g,"_")}).success(function(e){return t(r?n._buildMakeSpecificInventory(e):n._buildInventory(e))}).error(function(e){return i(e)})})}},{key:"search",value:function(e){var r=e.firstOrDefault(function(e){return"Make"===e.field}),i=r?r.value.toLowerCase():null;this._limitMakesTo&&1===this._limitMakesTo.length&&(i=this._limitMakesTo[0]);var a=this._vehiclePromises[i||"all"]?this._vehiclePromises[i||"all"]:this._vehiclePromises[i||"all"]=this._fetchRefData(i);return t.await(function(t,i){a.then(function(a,o){a&&i(a);var l=r?e:e.where(function(e){return"Trim"!=e.field}),u=o.where(function(e){return l.where(function(e){return null!==e}).all(function(r){return r.apply(e)})}).toArray();t(n.Enumerable.from(u))})})}}]),r}(),s=function(){function r(i){var a=this;_classCallCheck(this,r),this._baseFilter=i||"",this._vehiclePromise=t.await(function(r,t){var i=a._baseFilter||"";l.info('Getting vehicles for filter "{0}"',i),e.get("/api/inventory/query/").query({filter:i}).success(function(e){l.info("Retrieved vehicles from inventory API");var t=n.Enumerable.from(e).select(function(e){return new o(e)}),i=n.Enumerable.from(t.toArray());r(i)}).error(function(e,r,n){return t(new Error("Inventory API failed with status "+r))})})}return _createClass(r,[{key:"search",value:function(e){var r=this;return e=n.Enumerable.from(e),t.await(function(t,i){r._vehiclePromise.then(function(r,a){if(r)return void i(r);var o=a.where(function(r){return e.where(function(e){return null!==e}).all(function(e){return e.apply(r)})}).toArray();t(n.Enumerable.from(o))})})}}]),r}(),c=function(){function e(){_classCallCheck(this,e),this._collections={}}return _createClass(e,[{key:"createCollection",value:function(e){return this._collections[e]||(this._collections[e]=new s(e))}},{key:"createVirtualCollection",value:function(e){return new u(e)}},{key:"buildQuerystring",value:function(e){return e.select(function(e){return e.toString()}).toArray().join("&")}}]),e}();return new c});