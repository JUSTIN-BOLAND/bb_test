"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var l,u=e[Symbol.iterator]();!(n=(l=u.next()).done)&&(r.push(l.value),!t||r.length!==t);n=!0);}catch(o){i=!0,a=o}finally{try{!n&&u["return"]&&u["return"]()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();dealeron.runtime.define(["core/inventory/InventoryManager","core/inventory/filters","system/text","system/logManager","system/linq","system/async","system/html"],function(e,t,r,n,i,a,l){function u(e,t){return"Price"===t?o(e):e.toString()}function o(e){return"$"+(e||"").toLocaleString().split(".")[0]}function c(e,t){var r=e.where(function(e){return e>""});return!r.any()||r.all(function(e){return t.any(function(t){return t.field===e})})}var s=n.getLogger("Inventory Search Widget"),f=window.DealerOnTrack.event,h=window.jQuery;h||s.warn("jQuery is not detected on this page. The widget will work, but animated count will not."),f||s.warn("DealerOnTrack.event is not detected on this page. Google Analytics tracking will not happen.");var d={orMore:"or more",orLess:"or less",maxPrice:99999999,minPrice:1,filterAttribute:"inventory-filter",actionAttribute:"inventory-action",infoAttribute:"inventory-info",placeholderAttribute:"inventory-filter-placeholder",dependAttribute:"inventory-depend-on",defaultPriceRanges:[{low:null,high:5e3},{low:5001,high:1e4},{low:10001,high:15e3},{low:15001,high:2e4},{low:20001,high:25e3},{low:25001,high:3e4},{low:30001,high:4e4},{low:40001,high:5e4},{low:50001,high:6e4},{low:60001,high:null}],defaultAnimationDuration:1e3,defaultPlaceholder:"Any {field}",filterPattern:/(\w+)\:?(\w*)/,staticFilter:"__static__"},v=function(){function e(t,r,n,i){_classCallCheck(this,e),this.element=t,this.property=r,this.availableFilters=n,this._isFirstUpdate=i}return _createClass(e,[{key:"toString",value:function(){return""+this.property}},{key:"updateElement",value:function(e,n,i){var a=this,o=d.filterPattern.exec(this.element.getAttribute(d.filterAttribute)),c=_slicedToArray(o,3),s=c[1],f=c[2];if("SELECT"===this.element.tagName&&s!==d.staticFilter){var h=l.value(this.element);if(this.element.options.length=0,this._writePlaceholder(),!this.element.disabled){var v=1===this.availableFilters.count(),g=h&&this.availableFilters.any(function(e){return e.innerFilter.value==h});if("low"===f&&!g){var p=this.availableFilters.firstOrDefault();h=p?p.innerFilter.value:h,i()}if("high"===f&&!g){var y=this.availableFilters.lastOrDefault();h=y?y.innerFilter.value:h,i()}this.availableFilters.forEach(function(n){var l=document.createElement("OPTION");if(n.innerFilter instanceof t.BasicFilter||n.innerFilter instanceof t.TextFilter||n.innerFilter instanceof t.StockVinFilter||n.innerFilter instanceof t.MultipleValuesFilter)l.value=n.innerFilter.value,l.innerHTML=r.from("{0}",n.innerFilter.value),v&&!e.selectPlaceholder&&a._isFirstUpdate?(l.selected=!0,i()):l.selected=n&&n.innerFilter&&h&&r.equalsIgnoreCase(n.innerFilter.value,h);else if(n.innerFilter instanceof t.RangeFilter){l.value=r.from("{0}-{1}",n.innerFilter.low,n.innerFilter.high);var o=n.innerFilter.low!==d.minPrice,c=n.innerFilter.high!==d.maxPrice;if(o&&c?l.innerHTML=r.from("{0} - {1}",u(n.innerFilter.low,a.property),u(n.innerFilter.high,a.property)):!o&&c?l.innerHTML=r.from("{0} {1}",u(n.innerFilter.high,a.property),d.orLess):o&&!c&&(l.innerHTML=r.from("{0} {1}",u(n.innerFilter.low,a.property),d.orMore)),h){var s=h.split("-"),f=parseInt(s[0]),g=parseInt(s[1]);l.selected=n&&n.innerFilter&&f===n.innerFilter.low&&g===n.innerFilter.high}}a.element.appendChild(l)})}}}},{key:"_writePlaceholder",value:function(){var e=this.element.getAttribute(d.placeholderAttribute);if(e){var t=document.createElement("OPTION");t.value="",t.innerHTML=e,this.element.appendChild(t)}}}]),e}(),g=function(){function e(t,r){_classCallCheck(this,e),this.innerFilter=t,this.count=r}return _createClass(e,[{key:"apply",value:function(e){return this.innerFilter.apply(e)}},{key:"equals",value:function(t){return t instanceof e&&t.innerFilter.equals(this.innerFilter)&&t.count===this.count}},{key:"toString",value:function(){return this.innerFilter+" ("+this.count+")"}}]),e}();return function(){function n(t,r){_classCallCheck(this,n),r.useVirtual&&s.debug("Inventory widget will use virtual inventory."),r.priceRanges=r.priceRanges||d.defaultPriceRanges,r.animationDuration=r.animationDuration||d.defaultAnimationDuration,this._rootTag=t,this._config=r,this._isFirstUpdate=!0,this._collection=r.useVirtual?e.createVirtualCollection({limitYearsTo:r.virtualYears,limitMakesTo:r.virtualMakes}):e.createCollection(r.baseFilter)}return _createClass(n,[{key:"start",value:function(){var e=this;this._readForm(),l.query(this._rootTag,"[{filterAttribute}]",d).forEach(function(t){return e._initializeFilterElement(t)}),l.query(this._rootTag,"[{actionAttribute}]",d).forEach(function(t){return e._activateActionElement(t)}),this._rootTag.addEventListener("keypress",function(t){switch(t.keyCode){case 13:return void e._search(t)}}),this._config.rescanOnEvent&&h&&h(this._rootTag).on(this._config.rescanOnEvent,function(t){return e._readForm(t)})}},{key:"getCurrentFilters",value:function(){var e=this,t=l.query(this._rootTag,this._config.selector||"[{filterAttribute}]",d).where(function(e){return!e.disabled}).select(function(t){return e._getSingleFilterOrNull(t)}).where(function(e){return null!==e}).toArray();return i.Enumerable.from(t)}},{key:"_initializeFilterElement",value:function(e){var t=this;if(e.addEventListener("change",function(e){return t._readForm(e)}),"INPUT"===e.tagName){var n=e.getAttribute("type");r.equalsIgnoreCase(n,"TEXT")&&e.addEventListener("keyup",function(e){return t._readForm(e)})}var i=e.getAttribute(d.filterAttribute);if("SELECT"===e.tagName&&i!==d.staticFilter){var a=document.createElement("OPTION");a.value="",a.innerHTML=e.getAttribute(d.placeholderAttribute)||r.from(d.defaultPlaceholder,{field:i.split(":")[0]}),e.appendChild(a)}}},{key:"_readForm",value:function(e){var t=e&&e.target,r=t&&"text"!==e.target.getAttribute("type"),n=t&&("SELECT"!==e.target.tagName||e.target.getAttribute(d.filterAttribute)===d.staticFilter);if(t){var i=l.findParentAttribute(e.target,"inventory-tab");i&&(this._activeTab=i)}var a=r&&n;return a?void this._reset(e):void this._promiseFormUpdate(this.getCurrentFilters()).execute()}},{key:"_activateActionElement",value:function(e){var t=this,r=e.getAttribute(d.actionAttribute);switch(r.toLowerCase()){case"search":e.addEventListener("click",function(e){return t._search(e)});break;case"reset":e.addEventListener("click",function(e){return t._reset(e)});break;case"first":e.addEventListener("click",function(e){return t._first(e)})}}},{key:"_getSingleFilterOrNull",value:function(e){var n=e.getAttribute(d.filterAttribute),i=l.value(e),a=(e.getAttribute("type")||"").toUpperCase();if(!n||!i||"RADIO"===a&&!e.checked)return null;var u=d.filterPattern.exec(n),o=_slicedToArray(u,3),c=o[1],s=o[2];if("low"===s)return new t.RangeFilter(c,i,null);if("high"===s)return new t.RangeFilter(c,null,i);switch(c){case d.staticFilter:var f=/(\w+):(.+)/.exec(i),h=_slicedToArray(f,3),v=h[1],g=h[2];return new t.BasicFilter(v,r.parseType(g));case"Features":return new t.MultipleValuesFilter(c,i);case"Price":var p=i.split("-"),y=parseInt(p[0])||d.minPrice,m=parseInt(p[1])||d.maxPrice;return new t.RangeFilter(c,y,m);case"Vin":case"StockNum":return new t.TextFilter(c,i);case"StockVin":return new t.StockVinFilter(i)}return new t.BasicFilter(c,i)}},{key:"_promiseFormUpdate",value:function(e){var t=this;return a.await(function(r,n){t._collection.search(e).then(function(i,u){if(i)return void n(i);var o=l.query(t._rootTag,"[{filterAttribute}]",d);o.forEach(function(r){return t._processDependencies(r,e)});var c=o.select(function(e){return t._promiseRefinements(e,t._getSingleFilterOrNull(e),t.getCurrentFilters())}).where(function(e){return null!==e});a.awaitAll(c).then(function(i,a){if(i)return void n(i);var o=!1,c=function(){return o=!0};a.forEach(function(r){return r.updateElement(t._config,e,c)}),l.query(t._rootTag,"[{infoAttribute}]",d).forEach(function(e){return t._updateDataElement(e,u)}),l.query(t._rootTag,"[{actionAttribute}]",d).forEach(function(r){return t._checkActionElement(r,e,u)}),o&&t._promiseFormUpdate(t.getCurrentFilters()).execute(),t._isFirstUpdate=!1,r()})})})}},{key:"_processDependencies",value:function(e,t){var r=i.Enumerable.from((e.getAttribute(d.dependAttribute)||"").split(",")),n=c(r,t);e.disabled=!n}},{key:"_promiseRefinements",value:function(e,r,n){var l=this,u=this._config.showMakeFirst;if("SELECT"!==e.tagName||e.getAttribute(d.filterAttribute)===d.staticFilter)return null;var o=d.filterPattern.exec(e.getAttribute(d.filterAttribute)),c=_slicedToArray(o,3),s=c[1],f=(c[2],this._config.useVirtual&&"Make"===s?n.where(function(e){return!e.equals(r)&&["Year","Make","Model"].indexOf(e.field)!==-1}):n.where(function(e){return!e.equals(r)}));switch(s){case"Price":return a.await(function(r,n){l._collection.search(f).then(function(a,u){if(a)return void n(a);var o=i.Enumerable.from(l._config.priceRanges),c=u.select(function(e){return e.Price}).where(function(e){return e>0}).groupBy(function(e){return o.firstOrDefault(function(t){return(null===t.low||e>=t.low)&&(null===t.high||e<=t.high)})}).where(function(e){return null!==e.key()}).select(function(e){return new g(new t.RangeFilter(s,e.key().low||d.minPrice,e.key().high||d.maxPrice),e.count())}).orderBy(function(e){return e.innerFilter.low});r(new v(e,s,c,l._isFirstUpdate))})});case"Features":return a.await(function(r,n){l._collection.search(f).then(function(i,a){if(i)return void n(i);var u=a.selectMany(function(e){return e[s]}).distinct().select(function(e){return new g(new t.MultipleValuesFilter(s,e),a.count(function(t){return t[s].indexOf(e)!==-1}))}).orderBy(function(e){return e.innerFilter.low});r(new v(e,s,u,l._isFirstUpdate))})});default:return a.await(function(r,n){l._collection.search(f).then(function(i,a){if(i)return void n(i);var o=a.groupBy(function(e){return e[s]},null,null,function(e){return(""+e).toLowerCase()}).where(function(e){return e.key()>""}).select(function(e){return new g(new t.BasicFilter(s,e.key()),e.count())}).orderByDescending(function(e){return"Make"!==e.innerFilter.field||e.innerFilter.value===u}).thenBy(function(e){return e.innerFilter.value});r(new v(e,s,o,l._isFirstUpdate))})})}}},{key:"_updateDataElement",value:function(e,t){var r=e.getAttribute(d.infoAttribute)||"",n=this.getCurrentFilters().where(function(e){return null!==e});switch(r.toLowerCase()){case"animatedcount":var i=Number(e.innerHTML)||0,a=t.count();return h?void h({Counter:i}).animate({Counter:a},{duration:this._config.animationDuration,easing:"swing",step:function(t){return e.innerHTML=Math.ceil(t).toLocaleString().split(".")[0]}}):void(e.innerHTML=t.count().toLocaleString().split(".")[0]);case"count":return void(e.innerHTML=t.count().toLocaleString().split(".")[0]);case"minprice":return void(e.innerHTML=o(t.where(function(e){return e.Price>0}).min(function(e){return e.Price})));case"maxprice":return void(e.innerHTML=o(t.max(function(e){return e.Price})));case"avgprice":return void(e.innerHTML=o(t.average(function(e){return e.Price})));case"serializedfilters":return void(e.innerHTML=this._getSearchUrl(n,t.firstOrDefault()));case"modelphoto":var l=n.firstOrDefault(function(e){return"Model"===e.field}),u=t.firstOrDefault();return l&&u?(e.setAttribute("src",u.getPhotoUrl()),void(e.onerror=function(){return e.setAttribute("src",e.getAttribute("default-src"))})):void e.setAttribute("src",e.getAttribute("default-src"))}}},{key:"_checkActionElement",value:function(e,t,r){var n=i.Enumerable.from((e.getAttribute(d.dependAttribute)||"").split(",")),a=c(n,t);e.disabled=!a,a?e.removeAttribute("disabled"):e.setAttribute("disabled",!0);var l=e.getAttribute(d.actionAttribute);if("search"===l.toLowerCase()){var u=r.firstOrDefault(),o=t.firstOrDefault(),s="default";o?s="CPO"===o.field.toUpperCase()?"C":o.value:u&&(s=u.Type);var f=this._getSearchUrl(s,t);e.setAttribute("href",f)}}},{key:"_getSearchUrl",value:function(t,r){var n=e.buildQuerystring(r);switch(t){case"N":return(this._config.newSearchPage||"/searchnew.aspx")+"?"+n;case"U":return(this._config.usedSearchPage||"/searchused.aspx")+"?"+n;case"V":return"/searchnewv.aspx?"+n;case"C":return(this._config.usedSearchPage||"/searchused.aspx")+"?"+n;default:return(this._config.newSearchPage||"/searchnew.aspx")+"?"+n}}},{key:"_search",value:function(t){var r="Vertical Search Widget Inv. Searches";l.isHorizontal(t.target,"horizontalInventorySearch")&&(r="Horizontal Search Widget Inv. Searches"),f&&!this._config.disableTracking&&(s.debug("Sending Google Analytics Tracking Event"),DealerOnTrack.event(r,this._activeTab||"Default Search",e.buildQuerystring(this.getCurrentFilters())))}},{key:"_first",value:function(e){var t=this,r=this.getCurrentFilters();this._collection.search(r).then(function(r,n){if(r)throw r;var i=n.firstOrDefault();if(null===i)return s.error("No vehicles"),void e.preventDefault();if(i.isVirtual())return s.error("Cannot go directly to virtual VDP. Vehicle ID is not known."),void e.preventDefault();var a=i.getDetailsPageUrl();s.info("Navigating to vehicle {0}",a),f&&!t._config.disableTracking&&DealerOnTrack.event("Inventory Search Widget","Direct",i.Vin),window.location.href=a}),e.preventDefault()}},{key:"_reset",value:function(e){s.debug("Resetting Filters"),l.query(this._rootTag,"select[{filterAttribute}]",d).where(function(e){return e.getAttribute(d.filterAttribute)!==d.staticFilter}).forEach(function(e){return e.selectedIndex=0}),this._isFirstUpdate=!0,this._promiseFormUpdate(this.getCurrentFilters()).then(function(){return s.debug("Form reset")})}}]),n}()});